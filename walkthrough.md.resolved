# Auto-Reconnect System - Walkthrough

## Podsumowanie

Zaimplementowano kompletny system Auto-Reconnect dla rozszerzenia Gieniobot, umo≈ºliwiajƒÖcy:
- Zapisywanie stanu wszystkich modu≈Ç√≥w AFO (PVM, PVP, LPVM, GLEBIA, KODY)
- Bezpieczne przechowywanie credentials (login/has≈Ço)
- Automatyczne wykrywanie roz≈ÇƒÖczenia
- Auto-login i przywracanie stanu po reconnect

---

## Nowe Pliki

### üìÅ `remote/reconnect/`

| Plik | Rozmiar | Opis |
|------|---------|------|
| [credentials.js](file:///c:/Users/marci/Desktop/kw-antigravity/remote/reconnect/credentials.js) | 6.3 KB | ZarzƒÖdzanie has≈Çami (base64 obfuscation) |
| [stateManager.js](file:///c:/Users/marci/Desktop/kw-antigravity/remote/reconnect/stateManager.js) | 12.4 KB | Serializacja/deserializacja stanu modu≈Ç√≥w |
| [ui.js](file:///c:/Users/marci/Desktop/kw-antigravity/remote/reconnect/ui.js) | 24.4 KB | Ikonka + menu rozwijane |
| [reconnect.js](file:///c:/Users/marci/Desktop/kw-antigravity/remote/reconnect/reconnect.js) | 16 KB | Logika auto-reconnect |
| [index.js](file:///c:/Users/marci/Desktop/kw-antigravity/remote/reconnect/index.js) | 1.8 KB | Inicjalizacja systemu |

---

## Zmiany w IstniejƒÖcych Plikach

### [content_script1.js](file:///c:/Users/marci/Desktop/kw-antigravity/content_script1.js)

Dodano ≈Çadowanie modu≈Ç√≥w reconnect:

```diff
     // Activities auto-executor
     'remote/features/activities/activitiesExecutor.js',
 
+    // Auto-Reconnect system (credentials ‚Üí stateManager ‚Üí ui ‚Üí reconnect ‚Üí index)
+    'remote/reconnect/credentials.js',
+    'remote/reconnect/stateManager.js',
+    'remote/reconnect/ui.js',
+    'remote/reconnect/reconnect.js',
+    'remote/reconnect/index.js',
+
     // Auto clan training assists (runs independently after login)
     'remote/features/clanAssist.js',
```

---

## Jak U≈ºywaƒá

### 1. Ikona w Prawym G√≥rnym Rogu

Po zalogowaniu do gry, w prawym g√≥rnym rogu pojawi siƒô ikonka reconnect z kolorowym obramowaniem:

- üü¢ **Zielony** - stan zapisany, gotowy do reconnect
- üü° **≈ª√≥≈Çty** - stan nie zapisany (neutral)
- üî¥ **Czerwony** - b≈ÇƒÖd

### 2. Menu (kliknij ikonkƒô)

Menu zawiera:
- **Status** - czy stan jest zsynchronizowany
- **Czas ostatniego zapisu**
- **Serwer / Postaƒá** - aktualnie zalogowana postaƒá
- **Lista zapisanych modu≈Ç√≥w** - kt√≥re modu≈Çy by≈Çy aktywne

### 3. Zapisywanie Stanu

1. W≈ÇƒÖcz modu≈Çy kt√≥rych chcesz u≈ºyƒá (PVM, PVP, KODY, etc.)
2. Kliknij ikonkƒô reconnect
3. Kliknij **"üíæ Zapisz obecny stan"**
4. Stan zostanie zapisany per serwer + postaƒá

### 4. Konfiguracja Credentials

1. Kliknij ikonkƒô reconnect
2. Kliknij **"üë§ ZarzƒÖdzaj credentials"**
3. Wpisz login i has≈Ço
4. Kliknij **"üíæ Zapisz credentials"**

> [!WARNING]
> Credentials sƒÖ przechowywane lokalnie w chrome.storage.local z prostƒÖ obfuskacjƒÖ (base64). NIE sƒÖ szyfrowane. U≈ºywaj na w≈ÇasnƒÖ odpowiedzialno≈õƒá.

---

## Architektura

```mermaid
graph TB
    subgraph UI["UI Layer"]
        ICON[Ikonka] --> MENU[Menu rozwijane]
        MENU --> SAVE_BTN[Zapisz stan]
        MENU --> CREDS_FORM[Formularz credentials]
    end
    
    subgraph Core["Core Layer"]
        STATE[State Manager] --> |serialize| STORAGE[(chrome.storage)]
        CREDS[Credentials Manager] --> |encode/save| STORAGE
    end
    
    subgraph Monitor["Reconnect Monitor"]
        DETECTOR[Disconnect Detector] --> |disconnect| LOGIN[Auto-login]
        LOGIN --> RESTORE[Restore State]
        RESTORE --> MODULES[Start Modules]
    end
    
    SAVE_BTN --> STATE
    CREDS_FORM --> CREDS
    STORAGE --> RESTORE
```

---

## Zapisywane Dane per Modu≈Ç

### RESP (PVM)
- stop, wait, loc, code, kontoTP, codeTP
- bless, checkSSJ, checkOST, jaka, zmiana, multifight
- Wszystkie blesy (b1-b18)
- buff_imp, buff_clan, CONF_SENZU

### PVP
- stop, wait, wait2, loc, x, y, startX, startY
- code, autoWars, autoClanWars, g, speed
- higherRebornAvoid, dogory, tele, kontoTP, codeTP
- buff_imp, buff_clan

### LPVM
- Stop, Born, limit, limit2, wait, Map, pvm_killed

### GLEBIA
- stop, code, kontoTP, speed

### CODE
- stop, what_to_train, what_to_traintime
- acc, zast, b1, b2, checkSSJ

### Dodatkowe
- **spawnerIgnore** - GAME.spawner[1] dla PVM
- **Activities** - wybrane aktywno≈õci do wykonania

---

## Timing (Czasy Czekania)

| Operacja | Czas |
|----------|------|
| Sprawdzanie po≈ÇƒÖczenia | 10s |
| Po wype≈Çnieniu formularza logowania | 1.5s |
| Po zalogowaniu (lista postaci) | 3s |
| Po wybraniu postaci | 2s |
| ≈Åadowanie skrypt√≥w | 5s |
| Restart serwera (~11:50) | do 2 min |
| Max czas oczekiwania na GAME | 60s |
| Ponowna pr√≥ba po b≈Çƒôdzie | 5s |
| Max pr√≥b reconnect | 10 |

---

## Testowanie

### Test 1: Zapis/Odczyt Stanu

1. Zaloguj siƒô na postaƒá
2. W≈ÇƒÖcz PVM (np. na jakiej≈õ lokacji)
3. Kliknij ikonkƒô reconnect ‚Üí "Zapisz stan"
4. Powinno pokazaƒá toast "Stan zapisany pomy≈õlnie!"
5. Zamknij menu, otw√≥rz ponownie
6. W "Zapisane modu≈Çy" powinno byƒá widoczne "PVM (loc: X)"

### Test 2: Credentials

1. Kliknij ikonkƒô ‚Üí "ZarzƒÖdzaj credentials"
2. Wpisz login i has≈Ço
3. Kliknij "Zapisz credentials"
4. Zamknij menu, otw√≥rz ponownie
5. Kliknij "ZarzƒÖdzaj credentials"
6. Pola powinny byƒá wype≈Çnione

### Test 3: Reconnect (symulacja)

1. Zapisz stan i credentials
2. Otw√≥rz konsolƒô DevTools (F12)
3. Wpisz: `AFO_RECONNECT.handleDisconnect()`
4. Obserwuj logi - powinien pr√≥bowaƒá logowania

---

## Znane Ograniczenia

1. **"Aw Snap!" crashes** - wymaga Service Worker (przysz≈Ça faza)
2. **Bia≈Ça strona** - czƒô≈õciowo obs≈Çugiwane (redirect do kosmiczni.pl)
3. **Problem z internetem** - je≈õli przeglƒÖdarka sama od≈õwie≈ºy, powinno zadzia≈Çaƒá

---

## Nastƒôpne Kroki (opcjonalne)

- [ ] Service Worker dla obs≈Çugi crash/Aw Snap
- [ ] Automatyczne zapisywanie przy zmianie stanu modu≈Çu
- [ ] Historia reconnect√≥w / logi
- [ ] Notyfikacje Desktop
