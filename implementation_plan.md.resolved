# Auto-Reconnect & State Resume System

## Podsumowanie UstaleÅ„

Na podstawie feedbacku ustalono:

| Kwestia | Decyzja |
|---------|---------|
| HasÅ‚o | Base64 + obfuscation (wystarczy) |
| Zapisywanie stanu | On-demand (ikonka do klikniÄ™cia) |
| Multi-char | Per postaÄ‡ + serwer |
| Activities | Tak (arena, expeditions, otchÅ‚aÅ„) |
| Aw Snap handling | PÃ³Åºniej (MVP bez Service Worker) |
| Ikonka | [images/reconnect.png](file:///c:/Users/marci/Desktop/kw-antigravity/images/reconnect.png) (placeholder) |
| UI | Mobile-friendly, rozwijane menu |

**Dodatkowe wymagania:**
- PVM: zapisaÄ‡ teÅ¼ `GAME.spawner[1]` (spawnerIgnore)
- Czasy czekania: restart ~11:50 (2min loading), login (1-2s lista postaci), po wejÅ›ciu (1-2s skrypty)

---

## Architektura MVP (bez Service Worker)

```mermaid
graph TB
    subgraph "Content Script"
        ICON[Reconnect Icon] --> |click| MENU[Dropdown Menu]
        MENU --> |save| SM[State Manager]
        MENU --> |credentials| CRED[Credentials Form]
        SM --> |serialize| STORAGE[(chrome.storage.local)]
        
        DETECT[Disconnect Detector] --> |disconnect| RECOVER[Recovery Module]
        RECOVER --> |read| STORAGE
        RECOVER --> |login| LOGIN[Auto Login]
        LOGIN --> |restore| SM
    end
```

---

## Komponenty do Implementacji

### 1. State Manager (`remote/reconnect/stateManager.js`)

Odpowiedzialny za serializacjÄ™ i deserializacjÄ™ stanu moduÅ‚Ã³w.

```javascript
const AFO_STATE_MANAGER = {
  // ModuÅ‚y do zapisania
  MODULES: {
    // PVM (resp)
    RESP: ['stop', 'wait', 'loc', 'code', 'kontoTP', 'codeTP', 'bless', 
           'checkSSJ', 'checkOST', 'jaka', 'zmiana', 'multifight',
           'b1', 'b2', 'b3', 'b4', 'b5', 'b6', 'b7', 'b8', 'b9', 'b10',
           'b11', 'b12', 'b13', 'b14', 'b15', 'b16', 'b17', 'b18',
           'buff_imp', 'buff_clan', 'CONF_SENZU'],
    
    // PVP
    PVP: ['stop', 'wait', 'wait2', 'loc', 'x', 'y', 'startX', 'startY',
          'code', 'autoWars', 'autoClanWars', 'g', 'speed', 'speedMultiplier',
          'higherRebornAvoid', 'dogory', 'tele', 'kontoTP', 'codeTP',
          'buff_imp', 'buff_clan'],
    
    // LPVM (Listy goÅ„cze)
    LPVM: ['Stop', 'Born', 'limit', 'limit2', 'wait', 'Map', 'pvm_killed'],
    
    // GLEBIA
    GLEBIA: ['stop', 'code', 'kontoTP', 'speed'],
    
    // CODE (kody/trening)
    CODE: ['stop', 'what_to_train', 'what_to_traintime', 'acc', 'zast', 
           'b1', 'b2', 'checkSSJ'],
    
    // DAILY
    DAILY: ['stop', 'enabledQuests', 'combatLoc', 'substance', 'useCompressor']
  },
  
  // Dodatkowe dane do zapisania
  EXTRA: {
    spawnerIgnore: () => GAME.spawner?.[1] || [],  // Z GAME obiekt
    server: () => GAME.server,
    charId: () => GAME.char_id
  }
};
```

### 2. Credentials Manager (`remote/reconnect/credentials.js`)

```javascript
const AFO_CREDENTIALS = {
  // Proste "szyfrowanie" base64 + obfuscation
  encode(str) {
    return btoa(str.split('').reverse().join(''));
  },
  
  decode(str) {
    return atob(str).split('').reverse().join('');
  },
  
  async save(login, password, server, charId) {
    const key = `gieniobot_creds_s${server}_c${charId}`;
    await chrome.storage.local.set({
      [key]: {
        login: this.encode(login),
        password: this.encode(password),
        server,
        charId
      }
    });
  },
  
  async get(server, charId) {
    const key = `gieniobot_creds_s${server}_c${charId}`;
    const data = await chrome.storage.local.get(key);
    if (data[key]) {
      return {
        login: this.decode(data[key].login),
        password: this.decode(data[key].password),
        server: data[key].server,
        charId: data[key].charId
      };
    }
    return null;
  }
};
```

### 3. Reconnect Module (`remote/reconnect/reconnect.js`)

```javascript
const AFO_RECONNECT = {
  // Czasy czekania (ms)
  TIMING: {
    CHECK_INTERVAL: 10000,       // Co 10s sprawdzaj poÅ‚Ä…czenie
    LOGIN_WAIT: 3000,            // Po loginie czekaj na listÄ™ postaci
    CHAR_SELECT_WAIT: 2000,      // Po wyborze postaci
    SCRIPTS_LOAD_WAIT: 5000,     // Czekaj na zaÅ‚adowanie skryptÃ³w
    SERVER_RESTART_WAIT: 120000  // 2 min na restart serwera (~11:50)
  },
  
  // Warunki wykrywajÄ…ce rozÅ‚Ä…czenie
  isDisconnected() {
    const komCon = document.getElementById('kom_con');
    const gameWin = document.querySelector('#game_win');
    
    return (
      typeof GAME === 'undefined' ||
      (komCon && komCon.innerText.includes('RozÅ‚Ä…czono z serwerem!')) ||
      (gameWin && (gameWin.style.display === 'none' || gameWin.style.display === 'hidden')) ||
      !GAME.pid ||
      GAME.char_id === 0
    );
  },
  
  // Czy to ekran wyboru postaci?
  isCharacterSelect() {
    return typeof GAME !== 'undefined' && (GAME.char_id === 0 || !GAME.char_id);
  }
};
```

### 4. UI (`remote/reconnect/ui.js`)

**Lokalizacja ikonki:** Prawy gÃ³rny rÃ³g, obok innych kontrolek

**Kolory statusu:**
- ğŸ”´ Czerwony: niezsynchronizowane / bÅ‚Ä…d
- ğŸŸ¢ Zielony: zapisane i gotowe
- ğŸŸ¡ Å»Ã³Å‚ty/biaÅ‚y: neutralny / pierwsze uruchomienie

**Menu rozwijane (mobile-friendly):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ AUTO-RECONNECT       [âœ•]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: ğŸŸ¢ Zsynchronizowane    â”‚
â”‚ Zapisano: 00:15:32             â”‚
â”‚                                 â”‚
â”‚ â”Œâ”€ Aktywne moduÅ‚y â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ… PVM (loc: Ziemia)       â”‚ â”‚
â”‚ â”‚ âŒ PVP                      â”‚ â”‚
â”‚ â”‚ âœ… KODY (SiÅ‚a, 1h)         â”‚ â”‚
â”‚ â”‚ âŒ LPVM                     â”‚ â”‚
â”‚ â”‚ âŒ GÅÄ˜BIA                   â”‚ â”‚
â”‚ â”‚ âœ… Arena, Expeditions      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚ [ ğŸ’¾ Zapisz stan ]             â”‚
â”‚ [ ğŸ—‘ï¸ WyczyÅ›Ä‡ ]                 â”‚
â”‚ [ ğŸ‘¤ ZmieÅ„ credentials ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Zmiany w Plikach

### Nowe pliki:
| Plik | Opis |
|------|------|
| `remote/reconnect/stateManager.js` | Serializacja stanu moduÅ‚Ã³w |
| `remote/reconnect/credentials.js` | ZarzÄ…dzanie danymi logowania |
| `remote/reconnect/reconnect.js` | Logika wykrywania i wznawiania |
| `remote/reconnect/ui.js` | UI (ikonka + menu) |

### Modyfikowane pliki:
| Plik | Zmiany |
|------|--------|
| [manifest.json](file:///c:/Users/marci/Desktop/kw-antigravity/manifest.json) | Dodanie `storage` permission (juÅ¼ jest!), web_accessible_resources |
| [content_script1.js](file:///c:/Users/marci/Desktop/kw-antigravity/content_script1.js) | Åadowanie nowych moduÅ‚Ã³w reconnect |
| [remote/afo/state.js](file:///c:/Users/marci/Desktop/kw-antigravity/remote/afo/state.js) | Ewentualne metody pomocnicze |

---

## Plan Implementacji

### Faza 1: Core (stateManager + credentials)
1. Stworzenie `remote/reconnect/stateManager.js`
2. Stworzenie `remote/reconnect/credentials.js`
3. Komunikacja z chrome.storage.local

### Faza 2: UI
1. Stworzenie `remote/reconnect/ui.js`
2. Ikonka z kolorami statusu
3. Menu rozwijane (mobile-friendly)
4. Formularze credentials

### Faza 3: Reconnect Logic
1. Stworzenie `remote/reconnect/reconnect.js`
2. Detekcja rozÅ‚Ä…czenia
3. Auto-login sekwencja
4. Przywracanie stanu moduÅ‚Ã³w

### Faza 4: Integracja
1. Update [content_script1.js](file:///c:/Users/marci/Desktop/kw-antigravity/content_script1.js) - Å‚adowanie moduÅ‚Ã³w
2. Update [manifest.json](file:///c:/Users/marci/Desktop/kw-antigravity/manifest.json) jeÅ›li potrzeba
3. Testy na rÃ³Å¼nych scenariuszach

---

## Timing i Czasy Czekania

```javascript
// Sekwencja reconnect
1. Wykrycie rozÅ‚Ä…czenia
2. JeÅ›li nie na kosmiczni.pl â†’ redirect
3. Wait 1s
4. SprawdÅº czy zalogowany
5. JeÅ›li nie â†’ wpisz login/hasÅ‚o, kliknij "Zaloguj"
6. Wait 3s (lista postaci)
7. JeÅ›li restart serwera (~11:50) â†’ wait do 2min
8. Wybierz postaÄ‡
9. Wait 2s (loading postaci)
10. Wait for GAME.pid (max 5s)
11. Wait 5s (skrypty)
12. PrzywrÃ³Ä‡ stan moduÅ‚Ã³w
13. âœ… Gotowe
```

---

## NastÄ™pne kroki

Gotowy do implementacji! Zaczynam od:
1. `stateManager.js` - core funkcjonalnoÅ›Ä‡
2. `credentials.js` - zarzÄ…dzanie hasÅ‚ami
3. `ui.js` - ikonka i menu
4. [reconnect.js](file:///c:/Users/marci/Desktop/kw-antigravity/legacy_reconnect.js) - logika wznawiania
5. Integracja w [content_script1.js](file:///c:/Users/marci/Desktop/kw-antigravity/content_script1.js)
